/**
 * ========================================
 * –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ - –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
 * ========================================
 */

/**
 * –°–æ–∑–¥–∞–µ—Ç –º–µ–Ω—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ç–∞–±–ª–∏—Ü—ã
 */
function onOpen() {
  try {
    const ui = SpreadsheetApp.getUi();
    const mainMenu = ui.createMenu('üîß InSales Manager');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    addFullCategoryMenu(mainMenu);
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é
    mainMenu
      .addSeparator()
      .addItem('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏', 'showMainSettings')
      .addItem('üìã –õ–æ–≥–∏', 'showLogsSheet')
      .addItem('‚ÑπÔ∏è –û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏', 'showAboutDialog');
    
    mainMenu.addToUi();
    
    console.log('‚úÖ –ú–µ–Ω—é InSales Manager –∑–∞–≥—Ä—É–∂–µ–Ω–æ'); // –ò–ó–ú–ï–ù–ï–ù–û: –≤–º–µ—Å—Ç–æ logInfo
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–Ω—é:', error);
    SpreadsheetApp.getUi().alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é: ' + error.message);
  }
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫
 */
function showMainSettings() {
  showAPIKeysSetup();
  
  const message = `‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø\n\n` +
                 `–î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n\n` +
                 `üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏:\n` +
                 `‚Ä¢ –°–µ–º–∞–Ω—Ç–∏–∫–∞ ‚Üí –ù–∞—Å—Ç—Ä–æ–∏—Ç—å API - –¥–ª—è —Å–±–æ—Ä–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤\n` +
                 `‚Ä¢ –ü–æ–∑–∏—Ü–∏–∏ ‚Üí –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä–∫–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å - –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π\n\n` +
                 `üîë Script Properties (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤):\n` +
                 `‚Ä¢ insalesApiKey - API –∫–ª—é—á InSales\n` +
                 `‚Ä¢ insalesPassword - –ü–∞—Ä–æ–ª—å InSales\n` +
                 `‚Ä¢ insalesShop - –î–æ–º–µ–Ω –º–∞–≥–∞–∑–∏–Ω–∞\n` +
                 `‚Ä¢ openaiApiKey - API –∫–ª—é—á OpenAI\n` +
                 `‚Ä¢ semantics_api_service - –°–µ—Ä–≤–∏—Å —Å–µ–º–∞–Ω—Ç–∏–∫–∏ (serpstat/ahrefs/semrush)\n` +
                 `‚Ä¢ semantics_api_key - API –∫–ª—é—á —Å–µ—Ä–≤–∏—Å–∞ —Å–µ–º–∞–Ω—Ç–∏–∫–∏`;
  
  ui.alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏', message, ui.ButtonSet.OK);
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–∏—Å—Ç –ª–æ–≥–æ–≤
 */
function showLogsSheet() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let logSheet = ss.getSheetByName('–õ–æ–≥–∏');
    
    if (!logSheet) {
      const ui = SpreadsheetApp.getUi();
      const response = ui.alert(
        '–õ–∏—Å—Ç –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω',
        '–õ–∏—Å—Ç —Å –ª–æ–≥–∞–º–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω. –°–æ–∑–¥–∞—Ç—å —Å–µ–π—á–∞—Å?',
        ui.ButtonSet.YES_NO
      );
      
      if (response === ui.Button.YES) {
        logSheet = ss.insertSheet('–õ–æ–≥–∏');
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–∏—Å—Ç –ª–æ–≥–æ–≤
        const headers = ['–î–∞—Ç–∞', '–í—Ä–µ–º—è', '–£—Ä–æ–≤–µ–Ω—å', '–°–æ–æ–±—â–µ–Ω–∏–µ', '–ö–æ–Ω—Ç–µ–∫—Å—Ç', '–î–µ—Ç–∞–ª–∏'];
        logSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
        logSheet.getRange(1, 1, 1, headers.length)
                .setBackground('#1976d2')
                .setFontColor('#ffffff')
                .setFontWeight('bold');
        
        logSheet.setColumnWidth(1, 100);
        logSheet.setColumnWidth(2, 80);
        logSheet.setColumnWidth(3, 80);
        logSheet.setColumnWidth(4, 400);
        logSheet.setColumnWidth(5, 200);
        logSheet.setColumnWidth(6, 300);
        
        logSheet.setFrozenRows(1);
      } else {
        return;
      }
    }
    
    ss.setActiveSheet(logSheet);
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –ª–æ–≥–æ–≤', error);
  }
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
 */
function showAboutDialog() {
  const ui = SpreadsheetApp.getUi();
  
  const message = `üì¶ InSales Manager v2.0\n\n` +
                 `–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ InSales\n\n` +
                 `‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:\n\n` +
                 `üìÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏:\n` +
                 `‚Ä¢ –ó–∞–≥—Ä—É–∑–∫–∞ —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π\n` +
                 `‚Ä¢ –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–∏—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n` +
                 `‚Ä¢ –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ\n\n` +
                 `üîë –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —è–¥—Ä–æ:\n` +
                 `‚Ä¢ –°–±–æ—Ä –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (Serpstat/Ahrefs/SEMrush)\n` +
                 `‚Ä¢ LSI –∏ —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ AI\n` +
                 `‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã\n\n` +
                 `ü§ñ AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è:\n` +
                 `‚Ä¢ SEO —Ç–µ–≥–∏ (Title, Description, H1)\n` +
                 `‚Ä¢ –û–ø–∏—Å–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n` +
                 `‚Ä¢ –ü–ª–∏—Ç–∫–∞ —Ç–µ–≥–æ–≤ —Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é\n` +
                 `‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è\n\n` +
                 `üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π:\n` +
                 `‚Ä¢ –°–Ω—è—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π –ø–æ –º–∞—Ä–∫–µ—Ä–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º\n` +
                 `‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ\n` +
                 `‚Ä¢ –°–≤—è–∑—å –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å –¥–∏–Ω–∞–º–∏–∫–æ–π –ø–æ–∑–∏—Ü–∏–π\n\n` +
                 `üõí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏:\n` +
                 `‚Ä¢ –ü–æ–¥–±–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏\n` +
                 `‚Ä¢ –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n\n` +
                 `–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è Binokl.shop üî≠`;
  
  ui.alert('–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏', message, ui.ButtonSet.OK);
}
