<!DOCTYPE html>
<html>
  <head>
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; margin: 0; }
      h2 { color: #1976d2; margin-top: 0; font-size: 18px; }
      .field { margin: 15px 0; }
      label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
      input, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
      input:focus, select:focus { outline: none; border-color: #1976d2; }
      .hint { font-size: 12px; color: #666; margin-top: 3px; }
      .loading { font-size: 12px; color: #1976d2; margin-top: 3px; }
      .buttons { margin-top: 25px; text-align: right; border-top: 1px solid #ddd; padding-top: 15px; }
      button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 14px; }
      .btn-cancel { background: #f1f3f4; color: #333; }
      .btn-cancel:hover { background: #e0e0e0; }
      .btn-create { background: #4caf50; color: white; }
      .btn-create:hover { background: #45a049; }
      .btn-create:disabled { background: #ccc; cursor: not-allowed; }
    </style>
  </head>
  <body>
    <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
    
    <div class="field">
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ *</label>
      <input type="text" id="title" placeholder="–¢–µ–∞—Ç—Ä–∞–ª—å–Ω—ã–µ –±–∏–Ω–æ–∫–ª–∏" autocomplete="off">
      <div class="hint">–≠—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ URL</div>
    </div>
    
    <div class="field">
      <label>–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
      <select id="parent">
        <option value="">üè† –ö–æ—Ä–Ω–µ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è (–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è)</option>
      </select>
      <div id="parentHint" class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...</div>
    </div>
    
    <div class="field">
      <label>
        <input type="checkbox" id="openDetail" checked> 
        –û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ª–∏—Å—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
      </label>
    </div>
    
    <div class="buttons">
      <button class="btn-cancel" onclick="google.script.host.close()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-create" id="createBtn" onclick="createCategory()">–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
    </div>
    
    <script>
      window.onload = function() {
        document.getElementById('title').focus();
        loadParentCategories();
      };
      
      function loadParentCategories() {
        const hint = document.getElementById('parentHint');
        hint.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...';
        hint.className = 'loading';
        
        google.script.run
          .withSuccessHandler(function(categories) {
            console.log('–ü–æ–ª—É—á–µ–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', categories.length);
            
            const select = document.getElementById('parent');
            
            if (categories.length === 0) {
              hint.textContent = '‚ö†Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
              hint.style.color = '#f44336';
              return;
            }
            
            categories.forEach(cat => {
              const option = document.createElement('option');
              option.value = cat.id;
              
              // –°–æ–∑–¥–∞—ë–º –æ—Ç—Å—Ç—É–ø –≤–∏–∑—É–∞–ª—å–Ω–æ
              const indent = '\u00A0\u00A0'.repeat(cat.level);
              option.textContent = indent + (cat.level > 0 ? '‚îî‚îÄ ' : '') + cat.title;
              
              select.appendChild(option);
              
              console.log('–î–æ–±–∞–≤–ª–µ–Ω–∞:', cat.id, cat.title, '—É—Ä–æ–≤–µ–Ω—å:', cat.level);
            });
            
            hint.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ' + categories.length;
            hint.className = 'hint';
            hint.style.color = '#4caf50';
          })
          .withFailureHandler(function(error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
            hint.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message;
            hint.style.color = '#f44336';
          })
          .getCategoriesForParentSelect();
      }
      
      function createCategory() {
        const title = document.getElementById('title').value.trim();
        
        if (!title) {
          alert('‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
          document.getElementById('title').focus();
          return;
        }
        
        const btn = document.getElementById('createBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ –°–æ–∑–¥–∞—é...';
        
        const parentValue = document.getElementById('parent').value;
        const parentId = parentValue === '' ? null : parseInt(parentValue);
        
        const data = {
          title: title,
          parent_id: parentId,
          openDetail: document.getElementById('openDetail').checked
        };
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:', data);
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è "' + title + '" —Å–æ–∑–¥–∞–Ω–∞!\n\nID: ' + result.categoryId);
              google.script.host.close();
            } else {
              alert('‚ùå –û—à–∏–±–∫–∞: ' + result.error);
              btn.disabled = false;
              btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
            }
          })
          .withFailureHandler(function(error) {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            btn.disabled = false;
            btn.textContent = '–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
          })
          .createNewCategoryMinimal(data);
      }
    </script>
  </body>
</html>